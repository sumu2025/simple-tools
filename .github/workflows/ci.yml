name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

# ================= å…¨å±€ç¯å¢ƒï¼ˆLogfireï¼‰ =================
env:
  LOGFIRE_TOKEN:          ${{ secrets.LOGFIRE_TOKEN }}
  LOGFIRE_SEND_TO_LOGFIRE: "true"
  LOGFIRE_SERVICE_NAME:    "simple-tools-ci"

# ======================================================
# â‘  ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆruff / black / isort / mypyï¼‰
# ======================================================
jobs:
  lint:
    name: Lint & Type-check
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Install Python 3.13.3
        uses: actions/setup-python@v5
        with:
          python-version: "3.13.3"

      - name: ğŸ“¦ Install Poetry 2.1.3
        uses: snok/install-poetry@v1
        with:
          version: "2.1.3"
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: â™»ï¸ Cache Poetry venv
        uses: actions/cache@v3
        with:
          path: .venv
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}

      - name: ğŸ“¥ Install deps
        run: poetry install --no-interaction --no-ansi

      # ---------- è¿è¡Œå„é¡¹æ£€æŸ¥ ----------
      - name: Ruff lint
        run: poetry run ruff check src tests

      - name: Black --check
        run: poetry run black --check src tests

      - name: isort --check
        run: poetry run isort --check-only src tests

      - name: mypy (strict)
        # é™å®šæºç ç›®å½•ï¼Œé˜²æ­¢ duplicate-module è¯¯åˆ¤
        run: poetry run mypy --strict src/simple_tools

# ======================================================
# â‘¡ å•å…ƒæµ‹è¯•ï¼ˆå«è¦†ç›–ç‡ï¼‰â€”â€” ä»…åœ¨ lint é€šè¿‡åæ‰§è¡Œ
# ======================================================
  test:
    name: Py${{ matrix.python-version }} â€¢ ${{ matrix.os }}
    needs: lint
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.13.3"]

    steps:
      - name: â¬‡ï¸ Checkout
        uses: actions/checkout@v4

      - name: ğŸ Install Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸ“¦ Install Poetry 2.1.3
        uses: snok/install-poetry@v1
        with:
          version: "2.1.3"
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: â™»ï¸ Cache Poetry venv
        uses: actions/cache@v3
        with:
          path: .venv
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}

      - name: ğŸ“¥ Install deps
        run: poetry install --no-interaction --no-ansi

      - name: Print sys.path
        # æˆ‘ä»¬æ·»åŠ äº†è¿™ä¸ªæ–°çš„æ­¥éª¤ï¼Œç”¨äºæ‰“å° Python çš„ sys.path åˆ—è¡¨ã€‚
        # è¿™å¯ä»¥å¸®åŠ©æˆ‘ä»¬äº†è§£ Python è§£é‡Šå™¨åœ¨ CI ç¯å¢ƒä¸­æ˜¯å¦‚ä½•æŸ¥æ‰¾æ¨¡å—çš„ã€‚
        run: python -c "import sys; print(sys.path)"

      - name: ğŸ§ª Run pytest (+coverage)
                run: poetry run pytest
                --cov=./src/simple_tools
                --cov-report=xml
                --cov-report=term-missing
                --cov-fail-under=70


      - name: â˜ï¸ Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-${{ matrix.os }}-${{ github.run_id }}
          path: |
            coverage.xml
            htmlcov/

# ======================================================
# â‘¢ æ„å»ºå‘å¸ƒåŒ… â€”â€” ä»…åœ¨æµ‹è¯•å…¨éƒ¨é€šè¿‡åæ‰§è¡Œ
# ======================================================
  build:
    name: Build & Package
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.13.3"

      - uses: snok/install-poetry@v1
        with:
          version: "2.1.3"

      - name: Build wheel / sdist
        run: poetry build

      - name: Upload dist
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ github.run_id }}
          path: dist/

      - name: Smoke-test install
        run: |
          pip install dist/*.whl
          tools --help
