# 简单工具集 - 第二阶段工作规划

*文档版本: 1.0 | 创建日期: 2025-05-28 | 目标周期: 3-4周*

## 阶段概述

### 阶段目标
在第一阶段完成5个核心工具的基础上，提升工具的使用体验和稳定性，使其从"能用"进化到"好用"。

### 核心原则
- **保持简单**：功能增强不等于功能膨胀
- **体验优先**：关注用户实际使用中的痛点
- **性能适度**：只优化真正的瓶颈
- **向后兼容**：新功能不破坏现有使用方式

## 功能增强清单

### 1. 进度显示系统（优先级：高）

#### 1.1 需求背景
- 处理大量文件时用户无法感知进度
- 长时间操作时用户可能误以为程序卡死
- 需要给用户合理的时间预期

#### 1.2 技术方案
- 使用 Click 内置的 `progressbar` 功能
- 不引入额外依赖（如 tqdm、rich）
- 只在操作超过一定阈值时显示进度条

#### 1.3 实现范围
| 工具 | 场景 | 阈值 |
|------|------|------|
| list_files | 扫描文件 | >1000个文件 |
| find_duplicates | 计算哈希 | >100个文件 |
| batch_rename | 批量重命名 | >50个文件 |
| text_replace | 文本替换 | >20个文件 |
| file_organizer | 文件移动 | >50个文件 |

#### 1.4 代码示例
```python
import click

def process_files_with_progress(files):
    """处理文件并显示进度"""
    if len(files) > 50:  # 超过阈值才显示进度条
        with click.progressbar(files, label='处理中') as bar:
            for file in bar:
                process_single_file(file)
    else:
        for file in files:
            process_single_file(file)
```

### 2. 输出格式支持（优先级：中）

#### 2.1 需求背景
- 用户需要将结果导入其他工具处理
- 便于自动化脚本集成
- 支持数据分析和报表生成

#### 2.2 支持格式
- **JSON**：结构化数据输出
- **CSV**：表格数据导出
- **Plain**：纯文本格式（默认）

#### 2.3 实现方式
```bash
# 添加 --format 参数
tools list ~/Documents --format json
tools duplicates . --format csv > duplicates.csv
```

#### 2.4 各工具输出格式设计

##### list_files
```json
{
  "path": "/Users/peacock/Documents",
  "total": 42,
  "files": [
    {
      "name": "report.pdf",
      "size": 1048576,
      "modified": "2025-05-28T10:30:00",
      "type": "file"
    }
  ]
}
```

##### find_duplicates
```csv
hash,size,count,file1,file2,file3
abc123,1048576,3,/path/file1.jpg,/path/file2.jpg,/path/file3.jpg
def456,2097152,2,/path/doc1.pdf,/path/doc2.pdf,
```

### 3. 配置文件支持（优先级：中）

#### 3.1 需求背景
- 避免重复输入常用参数
- 支持项目级别的工具配置
- 便于团队共享配置

#### 3.2 配置文件格式
- 文件名：`.simple-tools.yml` 或 `.simple-tools.yaml`
- 格式：YAML（人类友好）
- 位置：当前目录 > 用户目录

#### 3.3 配置示例
```yaml
# .simple-tools.yml
tools:
  # 全局配置
  verbose: true
  format: json

  # 各工具配置
  list:
    show_all: true
    long: true

  duplicates:
    recursive: true
    min_size: 1048576  # 1MB

  rename:
    dry_run: true

  replace:
    extensions: [.txt, .md, .rst]

  organize:
    mode: type
    recursive: false
```

#### 3.4 实现注意事项
- 命令行参数优先级高于配置文件
- 配置文件可选，不强制要求
- 保持简单，避免过度配置

### 4. 错误处理增强（优先级：高）

#### 4.1 需求背景
- 当前错误信息不够友好
- 缺少错误恢复建议
- 批量操作中的错误处理不完善

#### 4.2 改进方案

##### 4.2.1 友好的错误信息
```python
# 现在
FileNotFoundError: [Errno 2] No such file or directory: '/path/to/file'

# 改进后
错误：找不到文件或目录
  路径：/path/to/file
  建议：请检查文件路径是否正确，或使用 'tools list' 查看可用文件
```

##### 4.2.2 批量操作错误处理
- 继续处理其他文件，不因单个错误中断
- 最后汇总显示所有错误
- 提供 `--stop-on-error` 选项

##### 4.2.3 错误恢复建议
| 错误类型 | 恢复建议 |
|----------|----------|
| 权限不足 | 建议使用 sudo 或检查文件权限 |
| 磁盘空间不足 | 建议清理磁盘或选择其他位置 |
| 文件已存在 | 建议使用不同名称或 --force 选项 |
| 编码错误 | 建议指定正确的编码或跳过二进制文件 |

### 5. 性能优化（优先级：低）

#### 5.1 优化策略
- **延迟优化**：基于 Logfire 监控数据决定
- **按需优化**：只优化确实存在的瓶颈
- **简单优先**：优先考虑简单的优化方案

#### 5.2 潜在优化点
1. **文件哈希计算**：
   - 大文件分块读取（当前是一次性读取）
   - 相同大小文件才计算哈希

2. **目录扫描**：
   - 使用 `os.scandir()` 替代 `os.listdir()`
   - 懒加载文件属性

3. **文本处理**：
   - 大文件使用流式处理
   - 编译正则表达式（如果后续支持）

### 6. 用户交互增强（优先级：中）

#### 6.1 交互式确认
```python
# 增强的确认提示
def confirm_operation(files_count, operation):
    """显示详细的确认信息"""
    click.echo(f"\n即将{operation} {files_count} 个文件")
    click.echo("操作不可撤销，请谨慎确认！")

    # 显示前几个文件作为预览
    if files_count > 5:
        click.echo("\n预览前 5 个文件...")
        # 显示文件列表

    return click.confirm("\n是否继续？", default=False)
```

#### 6.2 操作历史记录
- 记录每次操作的基本信息
- 保存在 `~/.simple-tools/history.log`
- 提供 `tools history` 命令查看

#### 6.3 智能提示
- 命令输错时提示相似命令
- 参数缺失时给出使用示例
- 常见错误的快速修复建议

## 实施计划

### 第1周：基础设施准备
- [ ] 设计统一的进度显示接口
- [ ] 实现基础的格式化输出框架
- [ ] 完成配置文件加载机制

### 第2周：核心功能实现
- [ ] 为每个工具添加进度显示
- [ ] 实现 JSON/CSV 输出格式
- [ ] 完成错误处理增强

### 第3周：用户体验优化
- [ ] 实现交互式确认增强
- [ ] 添加操作历史记录
- [ ] 完善智能提示功能

### 第4周：测试与优化
- [ ] 补充新功能的单元测试
- [ ] 性能测试和必要优化
- [ ] 更新文档和使用示例

## 技术债务清理

### 需要重构的部分
1. **文件扫描逻辑**：抽取公共函数
2. **输出格式化**：统一输出接口
3. **错误处理**：标准化错误类型

### 测试覆盖提升
- 目标：从 70% 提升到 85%
- 重点：边界条件和错误处理
- 方式：渐进式补充，不追求一次到位

## 版本发布计划

### v0.2.0 发布标准
- [ ] 所有计划功能开发完成
- [ ] 测试覆盖率达到 85%
- [ ] 文档更新完整
- [ ] 在真实场景使用一周无重大问题

### 版本号规划
- **0.2.0**：第二阶段主要功能完成
- **0.2.x**：bug 修复和小改进
- **0.3.0**：进入第三阶段（AI 增强）

## 风险控制

### 避免过度设计
- 每个功能都要有明确的用户场景
- 优先解决 80% 用户的需求
- 保持工具的独立性

### 保持向后兼容
- 新增参数使用长选项
- 默认行为保持不变
- 废弃功能给出明确警告

### 控制复杂度
- 单个函数仍然不超过 20 行
- 新增代码控制在 500 行以内
- 拒绝"顺便"添加的功能

## 成功标准

### 量化指标
- [ ] 测试覆盖率 ≥ 85%
- [ ] 性能无明显下降（<10%）
- [ ] 新增代码 < 500 行
- [ ] 文档完整率 100%

### 用户体验
- [ ] 大批量操作有进度反馈
- [ ] 错误信息清晰易懂
- [ ] 支持自动化集成需求
- [ ] 保持简单易用的特点

## 每周复盘模板

```markdown
## 第 X 周复盘（日期）

### 本周完成
- [ ] 功能点1
- [ ] 功能点2

### 遇到的问题
- 问题1及解决方案
- 问题2及解决方案

### 下周计划
- [ ] 待完成任务1
- [ ] 待完成任务2

### 需要调整
- 计划调整说明
```

---

**核心提醒**：第二阶段是"锦上添花"而非"重新设计"，保持克制，专注体验！
